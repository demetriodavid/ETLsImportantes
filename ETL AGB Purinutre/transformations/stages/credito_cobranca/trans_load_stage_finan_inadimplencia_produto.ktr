<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>Trans Carga - Stage - Mov. Financeiro - InadimplÃªncia</name>
    <description />
    <extended_description />
    <trans_version />
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection />
        <schema />
        <table />
        <size_limit_lines />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject />
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject />
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject />
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject />
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection />
        <schema />
        <table />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection />
      <table />
      <field />
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>1000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file />
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2015/09/11 11:48:51.872</created_date>
    <modified_user>-</modified_user>
    <modified_date>2015/09/11 11:48:51.872</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>[DB] - MySQL - Fluig ECM</name>
    <server>${ORIGEM_FLUIG_HOST}</server>
    <type>MARIADB</type>
    <access>Native</access>
    <database>${ORIGEM_FLUIG_BANCO}</database>
    <port>${ORIGEM_FLUIG_PORTA}</port>
    <username>${ORIGEM_FLUIG_USER_NAME}</username>
    <password>${ORIGEM_FLUIG_PASSWORD}</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${ORIGEM_FLUIG_PORTA}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>[DB] - Oracle - AgriBusiness ERP</name>
    <server>${ORIGEM_ORACLE_HOST}</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>${ORIGEM_ORACLE_BANCO}</database>
    <port>${ORIGEM_ORACLE_PORTA}</port>
    <username>${ORIGEM_ORACLE_USER_NAME}</username>
    <password>${ORIGEM_ORACLE_PASSWORD}</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${ORIGEM_ORACLE_PORTA}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>[DB] - PostgreSQL - Vistra Templ BI</name>
    <server>${ORIGEM_VISTRA_HOST}</server>
    <type>POSTGRESQL</type>
    <access>Native</access>
    <database>${ORIGEM_VISTRA_BANCO}</database>
    <port>${ORIGEM_VISTRA_PORTA}</port>
    <username>${ORIGEM_VISTRA_USER_NAME}</username>
    <password>${ORIGEM_VISTRA_PASSWORD}</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${ORIGEM_VISTRA_PORTA}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>[DW] - PostgreSQL - Vistra BI</name>
    <server>${DESTINO_HOST}</server>
    <type>POSTGRESQL</type>
    <access>Native</access>
    <database>${DESTINO_BANCO}</database>
    <port>${DESTINO_PORTA}</port>
    <username>${DESTINO_USER_NAME_BD}</username>
    <password>${DESTINO_PASSWORD_BD}</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${DESTINO_PORTA}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>[DB] - Extracao ERP - Titulo a Receber</from>
      <to>Wait Truncate</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Wait Truncate</from>
      <to>[DW] - W - Stage Titulo Receber</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Wait Truncate</name>
    <type>BlockUntilStepsFinish</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <steps>
      <step>
        <name>[DW] - SQL - Truncate Table</name>
        <CopyNr>0</CopyNr>
      </step>
    </steps>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>298</xloc>
      <yloc>158</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>[DB] - Extracao ERP - Titulo a Receber</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DB] - Oracle - AgriBusiness ERP</connection>
    <sql>SELECT  
	C.CODI_EMP NK_EMPRESA
	, C.CODI_TRA NK_CLIENTE
	, COALESCE(REC.COD1_PES, -1) NK_VENDEDOR
	, COALESCE(I.CODI_PSV, INF.CODI_PSV, IDD.CODI_PSV) NK_PRODUTO
	, C.CTRL_CBR DD_ID_TITULO
	, REC.CTRL_REC DD_ID_PARCELA
	, cast(C.DATA_CBR as date) NK_DATA_FATURAMENTO
	, cast(REC.VENC_REC as date) NK_DATA_VENCIMENTO	
	, C.CODI_TDO NK_TIPO_DOCUMENTO	
	, SUM(CAST(((case when T.TIPO_TDO = 'D' then 1 else -1 end) * CASE WHEN FN.SOMAPARCELAS = 0 THEN COALESCE(I.QTDE_INO, INF.QUAN_INF, IDD.qtde_idd) ELSE COALESCE(I.QTDE_INO, INF.QUAN_INF, IDD.qtde_idd) * (REC.VLOR_REC/FN.SOMAPARCELAS) END) as numeric(21,9))) QTD_PROD_NOTA
	, SUM(CAST(((case when T.TIPO_TDO = 'D' then 1 else -1 end) * CASE WHEN COALESCE(TN.SOMAITENS, TNF.SOMAITENS, CDZ.tota_cds) = 0 THEN REC.VLOR_REC ELSE REC.VLOR_REC * ((COALESCE(I.QTDE_INO, INF.QUAN_INF, IDD.qtde_idd)*COALESCE(I.VLIQ_INO, INF.VLIQ_INF, IDD.vliq_idd))/COALESCE(TN.SOMAITENS, TNF.SOMAITENS, CDZ.tota_cds) ) END) AS NUMERIC(21,9))) VLR_PROD_NOTA
	, 0 QTD_PROD_BAIXA
	, 0 VLR_PROD_BAIXA
FROM CABREC C
JOIN RECEBER REC on REC.CTRL_CBR = C.CTRL_CBR
JOIN TIPDOC T on T.CODI_TDO = C.CODI_TDO
JOIN NOTACRC NC ON NC.CTRL_CBR = C.CTRL_CBR
JOIN (SELECT NC.CODI_EMP, NC.CODI_TRA, NC.NDOC_NOC, NC.SDOC_NOC, NC.TDOC_NOC, SUM(R.VLOR_REC) SOMAPARCELAS FROM NOTACRC NC INNER JOIN RECEBER R ON NC.CTRL_CBR = R.CTRL_CBR group by NC.CODI_EMP, NC.CODI_TRA, NC.NDOC_NOC, NC.SDOC_NOC, NC.TDOC_NOC) FN ON FN.CODI_EMP = NC.CODI_EMP AND FN.CODI_TRA = NC.CODI_TRA AND FN.NDOC_NOC = NC.NDOC_NOC and FN.sdoc_noc = nC.sDOC_NOC and fn.tdoc_noc = nc.tdoc_noc
LEFT JOIN INFENTRA INF ON NC.CODI_EMP = INF.CODI_EMP AND NC.CODI_TRA = INF.CODI_TRA AND  NC.ndoc_noc = INF.NUME_NFE AND NC.sdoc_noc = INF.SERI_NFE AND NC.tdoc_noc = 'NT'
LEFT JOIN (SELECT I.CODI_EMP, I.CODI_TRA, I.NUME_NFE, I.SERI_NFE,   SUM(I.QUAN_INF *I.VLIQ_INF) SOMAITENS FROM INFENTRA I GROUP BY I.CODI_EMP, I.CODI_TRA, I.NUME_NFE, I.SERI_NFE ) TNF ON INF.CODI_EMP = TNF.CODI_EMP AND INF.CODI_TRA = TNF.CODI_TRA AND INF.NUME_NFE = TNF.nume_nfe and INF.SERI_NFE = TNF.seri_nfe
LEFT JOIN NOTA N  ON  NC.CODI_EMP = N.CODI_EMP  AND NC.CODI_TRA = N.CODI_TRA AND NC.NDOC_NOC = N.NOTA_NOT AND NC.SDOC_NOC = N.SERI_NOT AND NC.TDOC_NOC = 'NE'
LEFT JOIN INOTA I ON N.npre_not = I.NPRE_NOT
LEFT JOIN (SELECT I.npre_not, SUM(I.QTDE_INO*I.VLIQ_INO) SOMAITENS FROM INOTA I GROUP BY I.NPRE_NOT) TN ON N.NPRE_NOT = TN.NPRE_NOT
-- LEFT JOIN docdesfaz DDZ ON NC.ndoc_noc = DDZ.codi_cds AND NC.codi_emp = DDZ.codi_emp AND NC.CODI_TRA = DDZ.CODI_TRA AND NC.TDOC_NOC = 'DZ'
LEFT JOIN IDOCDESFAZ IDD ON (IDD.CODI_CDS = nc.ndoc_noc AND IDD.CODI_EMP = nc.CODI_EMP AND nc.tdoc_noc = 'DZ')
LEFT JOIN CABDESFAZ CDZ ON IDD.CODI_CDS = CDZ.codi_cds AND IDD.CODI_EMP = CDZ.CODI_EMP
WHERE REC.SITU_REC &lt;&gt; 'C' AND C.CODI_EMP &lt;&gt; 45 AND C.CODI_TDO NOT IN ('3', '6', '103', '106','10000330') AND (T.TIPO_TDO &lt;&gt; 'C' or T.TIPO_TDO is null) 
-- AND REC.VENC_REC BETWEEN TO_DATE('2024/01/01','YYYY/MM/DD') AND TO_DATE('2024/03/01','YYYY/MM/DD')

GROUP BY 
	C.CTRL_CBR 
	, REC.CTRL_REC 
	, C.DATA_CBR 
	, COALESCE(I.CODI_PSV, INF.CODI_PSV, IDD.CODI_PSV) 
	, C.CODI_EMP 
	, C.CODI_TDO 
	, C.CODI_TRA 
	, COALESCE(REC.COD1_PES, -1) 
	, REC.VENC_REC
	
UNION ALL 

SELECT 
	C.CODI_EMP NK_EMPRESA
	, C.CODI_TRA NK_CLIENTE
	, COALESCE(R.COD1_PES, -1) NK_VENDEDOR
	, CBP.CODI_PSV NK_PRODUTO
	, C.CTRL_CBR DD_ID_TITULO
	, R.CTRL_REC DD_ID_PARCELA
	, cast(C.DATA_CBR as date) NK_DATA_FATURAMENTO
	, cast(R.VENC_REC as date) NK_DATA_VENCIMENTO	
	, C.CODI_TDO NK_TIPO_DOCUMENTO	
	, 0 QTD_PROD_NOTA
	, 0 VLR_PROD_NOTA
	, CAST(SUM(COALESCE((case when T.TIPO_TDO = 'D' then 1 else -1 end)*CBP.QTDP_BPR,0)) AS NUMERIC(21,9)) QTD_PROD_BAIXA
	, CAST(SUM((case when T.TIPO_TDO = 'D' then 1 else -1 end)*B.VLOR_BAI*COALESCE(I.VALORTOTALITEM/casE WhEn TOTALNE.VALORTOTALNOTA = 0 then 1 else TOTALNE.VALORTOTALNOTA end, INF.VALORTOTALITEM/case when TOTALNT.VALORTOTALNOTA = 0 then 1 else TOTALNT.VALORTOTALNOTA end,ICF.VALORTOTALITEM/case when TOTALCF.VALORTOTALNOTA = 0 then 1 else TOTALCF.VALORTOTALNOTA end)) AS NUMERIC(21,9)) VLR_PROD_BAIXA
	FROM CRCBAIXA B 
	INNER JOIN RECEBER R ON B.CTRL_REC = R.CTRL_REC
	INNER JOIN CABREC C ON R.CTRL_CBR = C.CTRL_CBR
	INNER JOIN TIPDOC T ON T.CODI_TDO = C.CODI_TDO
	INNER JOIN CRCBAIPR CBP ON B.SEQU_BAI = CBP.SEQU_BAI
	INNER JOIN NOTACRC NC ON C.CTRL_CBR = NC.CTRL_CBR 
	LEFT JOIN NOTA N ON NC.CODI_EMP = N.CODI_EMP AND NC.CODI_TRA = N.CODI_TRA AND NC.NDOC_NOC = N.NOTA_NOT AND NC.SDOC_NOC = N.SERI_NOT AND NC.TDOC_NOC = 'NE'
	LEFT JOIN (select I.NPRE_NOT, I.CODI_PSV, case when sum(i.qtde_ino) = 0 then sum(i.vliq_ino) else sum(I.QTDE_INO*I.VLIQ_INO)/sum(i.qtde_ino) end valorunitario, sum(case when (i.qtde_ino) = 0 then (i.vliq_ino) else (I.QTDE_INO*I.VLIQ_INO) end) valortotalitem FROM INOTA I GROUP BY I.NPRE_NOT, I.CODI_PSV) I ON N.NPRE_NOT = I.NPRE_NOT AND CBP.CODI_PSV = I.CODI_PSV
	LEFT JOIN (SELECT INF.CODI_EMP, INF.CODI_TRA, INF.NUME_NFE, INF.SERI_NFE,INF.CODI_PSV, case when sum(inf.quan_inf) = 0 then sum(inf.vliq_inf) else  SUM(INF.QUAN_INF*INF.VLIQ_INF)/SUM(QUAN_INF) end valorunitario, sum(case when (inf.quan_inf) = 0 then (inf.vliq_inf) else  (INF.QUAN_INF*INF.VLIQ_INF) end) valortotalitem FROM INFENTRA INF GROUP BY INF.CODI_EMP, INF.CODI_TRA, INF.NUME_NFE, INF.SERI_NFE, INF.CODI_PSV) INF ON NC.CODI_EMP = INF.CODI_EMP AND NC.CODI_TRA = INF.CODI_TRA AND NC.NDOC_NOC = INF.NUME_NFE AND NC.SDOC_NOC = INF.SERI_NFE AND CBP.CODI_PSV = INF.CODI_PSV AND  NC.TDOC_NOC = 'NT'
	LEFT JOIN (select I.NPRE_NOT, sum(case when (i.qtde_ino) = 0 then (i.vliq_ino) else (I.QTDE_INO*I.VLIQ_INO) end) valortotalnota FROM INOTA I GROUP BY I.NPRE_NOT) TOTALNE ON N.NPRE_NOT = TOTALNE.NPRE_NOT 
	LEFT JOIN (SELECT INF.CODI_EMP, INF.CODI_TRA, INF.NUME_NFE, INF.SERI_NFE,  sum(case when (inf.quan_inf) = 0 then (inf.vliq_inf) else  (INF.QUAN_INF*INF.VLIQ_INF) end) valortotalnota FROM INFENTRA INF GROUP BY INF.CODI_EMP, INF.CODI_TRA, INF.NUME_NFE, INF.SERI_NFE) TOTALNT ON NC.CODI_EMP = TOTALNT.CODI_EMP AND NC.CODI_TRA = TOTALNT.CODI_TRA AND NC.NDOC_NOC = TOTALNT.NUME_NFE AND NC.SDOC_NOC = TOTALNT.SERI_NFE  AND  NC.TDOC_NOC = 'NT'
	LEFT JOIN CUPOM CF ON NC.CODI_EMP = CF.CODI_EMP AND NC.CODI_TRA = CF.CODI_TRA AND NC.NDOC_NOC = CF.NVEN_CUP AND NC.TDOC_NOC = 'CF'
	LEFT JOIN (select ICF.NVEN_CUP, ICF.CODI_PSV, case when sum(ICF.QTDE_ICU) = 0 then sum(ICF.vliq_ICU) else sum(ICF.QTDE_ICU*ICF.vliq_ICU)/sum(ICF.QTDE_ICU) end VALORUNITARIO, sum(case when (ICF.QTDE_ICU) = 0 then (ICF.vliq_ICU) else (ICF.QTDE_ICU*ICF.vliq_ICU) end) VALORTOTALITEM FROM ICUPOM ICF GROUP BY ICF.NVEN_CUP, ICF.CODI_PSV) ICF ON CF.NVEN_CUP = ICF.NVEN_CUP AND ICF.CODI_PSV = CBP.CODI_PSV 
	LEFT JOIN (select I.NVEN_CUP , sum(case when (i.qtde_ICU) = 0 then (i.vliq_ICU) else (I.QTDE_ICU*I.VLIQ_ICU) end) valortotalnota FROM ICUPOM I GROUP BY I.NVEN_CUP) TOTALCF ON CF.NVEN_CUP = TOTALCF.NVEN_CUP
	WHERE B.SITU_BAI &lt;&gt; 'E'
		AND R.SITU_REC &lt;&gt; 'C' 
		--AND B.CODI_TPG  NOT IN ('10','3','11','12','10000006') 
		AND B.SITU_BAI &lt;&gt;'E'
		AND C.CODI_EMP &lt;&gt; 45 AND C.CODI_TDO NOT IN ('3', '6', '103', '106','10000330') AND (T.TIPO_TDO &lt;&gt; 'C' or T.TIPO_TDO is null)
GROUP BY C.CTRL_CBR,R.CTRL_REC,C.DATA_CBR,CBP.CODI_PSV,C.CODI_EMP,C.CODI_TDO,C.CODI_TRA,COALESCE(R.COD1_PES, -1),R.VENC_REC

</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>127</xloc>
      <yloc>158</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>[DW] - SQL - Truncate Table</name>
    <type>ExecSQL</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DW] - PostgreSQL - Vistra BI</connection>
    <execute_each_row>N</execute_each_row>
    <single_statement>N</single_statement>
    <replace_variables>N</replace_variables>
    <quoteString>N</quoteString>
    <sql>TRUNCATE TABLE STAGE.stg_mov_fin_inadimplencia_produto</sql>
    <set_params>N</set_params>
    <insert_field />
    <update_field />
    <delete_field />
    <read_field />
    <arguments>
    </arguments>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>309</xloc>
      <yloc>20</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>[DW] - W - Stage Titulo Receber</name>
    <type>TableOutput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DW] - PostgreSQL - Vistra BI</connection>
    <schema>stage</schema>
    <table>stg_mov_fin_inadimplencia_produto</table>
    <commit>100</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>Y</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field />
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field />
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field />
    <fields>
      <field>
        <column_name>NK_EMPRESA</column_name>
        <stream_name>NK_EMPRESA</stream_name>
      </field>
      <field>
        <column_name>NK_CLIENTE</column_name>
        <stream_name>NK_CLIENTE</stream_name>
      </field>
      <field>
        <column_name>NK_VENDEDOR</column_name>
        <stream_name>NK_VENDEDOR</stream_name>
      </field>
      <field>
        <column_name>NK_PRODUTO</column_name>
        <stream_name>NK_PRODUTO</stream_name>
      </field>
      <field>
        <column_name>DD_ID_TITULO</column_name>
        <stream_name>DD_ID_TITULO</stream_name>
      </field>
      <field>
        <column_name>DD_ID_PARCELA</column_name>
        <stream_name>DD_ID_PARCELA</stream_name>
      </field>
      <field>
        <column_name>NK_DATA_FATURAMENTO</column_name>
        <stream_name>NK_DATA_FATURAMENTO</stream_name>
      </field>
      <field>
        <column_name>NK_DATA_VENCIMENTO</column_name>
        <stream_name>NK_DATA_VENCIMENTO</stream_name>
      </field>
      <field>
        <column_name>NK_TIPO_DOCUMENTO</column_name>
        <stream_name>NK_TIPO_DOCUMENTO</stream_name>
      </field>
      <field>
        <column_name>QTD_PROD_NOTA</column_name>
        <stream_name>QTD_PROD_NOTA</stream_name>
      </field>
      <field>
        <column_name>VLR_PROD_NOTA</column_name>
        <stream_name>VLR_PROD_NOTA</stream_name>
      </field>
      <field>
        <column_name>QTD_PROD_BAIXA</column_name>
        <stream_name>QTD_PROD_BAIXA</stream_name>
      </field>
      <field>
        <column_name>VLR_PROD_BAIXA</column_name>
        <stream_name>VLR_PROD_BAIXA</stream_name>
      </field>
    </fields>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>514</xloc>
      <yloc>156</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
</transformation>
