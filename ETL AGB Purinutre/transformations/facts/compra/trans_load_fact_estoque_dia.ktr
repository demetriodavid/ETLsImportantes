<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>trans_load_fact_estoque_dia</name>
    <description />
    <extended_description />
    <trans_version />
    <trans_type>Normal</trans_type>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection />
        <schema />
        <table />
        <size_limit_lines />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject />
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject />
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject />
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject />
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection />
        <schema />
        <table />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection />
      <table />
      <field />
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file />
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2022/11/04 20:11:10.897</created_date>
    <modified_user>-</modified_user>
    <modified_date>2022/11/04 20:11:10.897</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>[DB] - Oracle - AgriBusiness ERP</name>
    <server>${ORIGEM_ORACLE_HOST}</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>${ORIGEM_ORACLE_BANCO}</database>
    <port>${ORIGEM_ORACLE_PORTA}</port>
    <username>${ORIGEM_ORACLE_USER_NAME}</username>
    <password>${ORIGEM_ORACLE_PASSWORD}</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${ORIGEM_ORACLE_PORTA}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>[DW] - PostgreSQL - Vistra BI</name>
    <server>${DESTINO_HOST}</server>
    <type>POSTGRESQL</type>
    <access>Native</access>
    <database>${DESTINO_BANCO}</database>
    <port>${DESTINO_PORTA}</port>
    <username>${DESTINO_USER_NAME_BD}</username>
    <password>${DESTINO_PASSWORD_BD}</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${DESTINO_PORTA}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Pega dia input</from>
      <to>Table input 2</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Table input 2</from>
      <to>Table output</to>
      <enabled>N</enabled>
    </hop>
    <hop>
      <from>Table input 2</from>
      <to>Insert / Update</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Insert / Update</name>
    <type>InsertUpdate</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DW] - PostgreSQL - Vistra BI</connection>
    <commit>10000</commit>
    <update_bypassed>N</update_bypassed>
    <lookup>
      <schema>public</schema>
      <table>FATO_SALDO_DIA_ESTOQUE</table>
      <key>
        <name>sk_empresa</name>
        <field>sk_empresa</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>sk_produto</name>
        <field>sk_produto</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>sk_tempo_dia</name>
        <field>sk_tempo_dia</field>
        <condition>=</condition>
        <name2 />
      </key>
      <value>
        <name>sk_empresa</name>
        <rename>sk_empresa</rename>
        <update>N</update>
      </value>
      <value>
        <name>sk_produto</name>
        <rename>sk_produto</rename>
        <update>N</update>
      </value>
      <value>
        <name>sk_tempo_dia</name>
        <rename>sk_tempo_dia</rename>
        <update>N</update>
      </value>
      <value>
        <name>estoque_fisico</name>
        <rename>estoque_fisico</rename>
        <update>Y</update>
      </value>
    </lookup>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>401</xloc>
      <yloc>337</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Pega dia input</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DW] - PostgreSQL - Vistra BI</connection>
    <sql>SELECT TO_CHAR(NK_TEMPO_DIA, 'DD/MM/YYYY') AS NK_TEMPO_DIA,
       TO_CHAR(NK_TEMPO_DIA, 'DD/MM/YYYY') AS NK_TEMPO_DIA2,
       TO_CHAR(NK_TEMPO_DIA, 'DD/MM/YYYY') AS NK_TEMPO_DIA3,
       NK_TEMPO_DIA AS NK_TEMPO_DIA4
       --NK_TEMPO_DIA AS TEMPO_DIA
  FROM DIM_TEMPO_DIA DTD
 WHERE DTD.NK_TEMPO_DIA >= '01/09/2022'
   AND DTD.NK_TEMPO_DIA &lt;= '27/11/2022' 
   --AND DTD.NK_TEMPO_DIA = CURRENT_DATE 
ORDER BY NK_TEMPO_DIA</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>157</xloc>
      <yloc>186</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table input 2</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DW] - PostgreSQL - Vistra BI</connection>
    <sql>   WITH PARAMS AS (
  SELECT TO_DATE(?, UPPER('DD/MM/YYYY'))                                  AS DATA_REF,
         CAST( TO_CHAR(TO_DATE(?, UPPER('DD/MM/YYYY')),UPPER('YYYYMMDD')) AS INTEGER) AS DD_ANO_MES_DIA_REF
    )
    ,PRODUTO AS 
    (SELECT DP.SK_PRODUTO,
            DP.COD_PRODUTO,
            DP.PRODUTO, 
            DSG.NK_SUBGRUPO,
            DSG.SUBGRUPO,
            DG.NK_GRUPO,
            DG.GRUPO,
            DL.NK_LINHA,
            DF.NK_FABRICANTE,
            DF.FABRICANTE,
            DP.PESO_LIQUIDO,
            DP.PRECO_MEDIO AS PRECO_MEDIO,
            DP.ATIVO AS DD_ATIVO
       FROM DIM_PRODUTO DP
            INNER JOIN DIM_GRUPO DG ON DG.NK_GRUPO = DP.NK_GRUPO
            INNER JOIN DIM_SUBGRUPO DSG ON DSG.NK_SUBGRUPO = DP.NK_SUBGRUPO
            INNER JOIN DIM_LINHA DL ON DL.NK_LINHA = DP.NK_LINHA
            INNER JOIN DIM_FABRICANTE DF ON DF.NK_FABRICANTE = DP.NK_FABRICANTE
      WHERE DF.SK_FABRICANTE  NOT IN (99998888)
        AND DG.NK_GRUPO       NOT IN ('99998888')
        AND DSG.NK_SUBGRUPO   NOT IN ('99998888')
        AND DP.NK_PRODUTO     NOT IN ('99998888')
   GROUP BY 1,2,3,4,5,6,7,8,9,10,11
    )
    ,AJ_SALDO_DATA AS
    (SELECT FAE.SK_EMPRESA,
            FAE.SK_PRODUTO,
            MAX(CASE
                    WHEN COALESCE(DD_AJUSTE_FISICO, 0) = 1 THEN FAE.SK_TEMPO_DIA
                END ) AS SK_TEMPO_DIA_AJ_FISICO,
            MAX(CASE
                    WHEN COALESCE(DD_AJUSTE_DISP, 0) = 1 THEN FAE.SK_TEMPO_DIA
                END ) AS SK_TEMPO_DIA_AJ_DISP
       FROM FATO_AJUSTE_ESTOQUE FAE
            INNER JOIN DIM_TEMPO_DIA DTD USING (SK_TEMPO_DIA)
            INNER JOIN PARAMS P ON TRUE
        WHERE DTD.NK_TEMPO_DIA &lt;= P.DATA_REF
        GROUP BY 1,2
    )
    ,AJ_SALDO AS(
     SELECT ASD.SK_EMPRESA,
            ASD.SK_PRODUTO,
            ASD.SK_TEMPO_DIA_AJ_FISICO,
            ASD.SK_TEMPO_DIA_AJ_DISP,
            SUM(FAEF.QTD_EST_FISICO) AS QTD_EST_FISICO,
            SUM(FAED.QTD_EST_DISP) AS QTD_EST_DISP
       FROM AJ_SALDO_DATA ASD
            LEFT OUTER JOIN FATO_AJUSTE_ESTOQUE FAEF ON FAEF.SK_EMPRESA = ASD.SK_EMPRESA
                                                    AND FAEF.SK_PRODUTO = ASD.SK_PRODUTO
                                                    AND FAEF.SK_TEMPO_DIA = ASD.SK_TEMPO_DIA_AJ_FISICO
            LEFT OUTER JOIN FATO_AJUSTE_ESTOQUE FAED ON FAED.SK_EMPRESA = ASD.SK_EMPRESA                  
                                                    AND FAED.SK_PRODUTO = ASD.SK_PRODUTO
                                                    AND FAED.SK_TEMPO_DIA = ASD.SK_TEMPO_DIA_AJ_DISP      
      GROUP BY 1,2,3,4
    )
    ,SALDO AS(
     SELECT F.SK_EMPRESA,
            F.SK_PRODUTO,
            SUM(CASE
                    WHEN(AJ.SK_EMPRESA IS NOT NULL AND F.SK_TEMPO_DIA > AJ.SK_TEMPO_DIA_AJ_FISICO) OR AJ.SK_EMPRESA IS NULL THEN F.QTD_EST_FISICO
                    ELSE 0
                END ) AS QTD_EST_FISICO,
            SUM(CASE
                    WHEN(AJ.SK_EMPRESA IS NOT NULL AND F.SK_TEMPO_DIA > AJ.SK_TEMPO_DIA_AJ_DISP) OR AJ.SK_EMPRESA IS NULL
                    THEN F.QTD_EST_DISP
                    ELSE 0
                END
            ) AS QTD_EST_DISP
        FROM
            FATO_MOVIMENTO_ESTOQUE_DIA F
            INNER JOIN PARAMS P ON TRUE
            LEFT OUTER JOIN AJ_SALDO AJ ON AJ.SK_EMPRESA = F.SK_EMPRESA AND
                AJ.SK_PRODUTO = F.SK_PRODUTO
        WHERE F.SK_TEMPO_DIA &lt;= P.DD_ANO_MES_DIA_REF
        GROUP BY 1,2
        UNION ALL
        SELECT
            SK_EMPRESA,
            SK_PRODUTO,
            QTD_EST_FISICO,
            QTD_EST_DISP
        FROM AJ_SALDO
    )
    ,SALDO_FINAL AS
    (SELECT P.SK_PRODUTO,
            S.SK_EMPRESA,
            P.COD_PRODUTO,
            P.FABRICANTE,
            P.GRUPO,
            P.SUBGRUPO,
            P.PRODUTO,
            P.PRECO_MEDIO,
            P.PESO_LIQUIDO,
            (CASE
                  WHEN P.DD_ATIVO = 1 THEN 'ATIVO'
                  ELSE 'INATIVO'
              END) AS SITUACAO,
            SUM(S.QTD_EST_FISICO) AS QTD_FISICO,
            SUM(S.QTD_EST_DISP)   AS QTD_DISP
       FROM SALDO S
            INNER JOIN PRODUTO P USING (SK_PRODUTO)
      WHERE S.SK_EMPRESA  NOT IN (99998888)
        
      GROUP BY 1,2,3,4,5,6,7,8,9,10
    )
    ,VENDAS AS (
     SELECT F.SK_PRODUTO,
            SUM(F.QTD_ITEM) AS QTD_VENDIDA,
            SUM(CASE
                    WHEN DOF.COD_TIPO_OPERACAO = 303 THEN F.QTD_ITEM
                    ELSE 0
                END)        AS QTD_VENDA_DIRETA
       FROM FATO_MOVIMENTO_VENDA_DIA F
            INNER JOIN DIM_TEMPO_DIA DTD USING (SK_TEMPO_DIA)
            INNER JOIN DIM_OPERACAO_FISCAL DOF USING (SK_OPERACAO_FISCAL)
            INNER JOIN PRODUTO P USING (SK_PRODUTO)
      WHERE DTD.NK_TEMPO_DIA BETWEEN TO_DATE( '01/01/2000', UPPER('DD/MM/YYYY'))
        AND TO_DATE( ?, UPPER('DD/MM/YYYY'))
      GROUP BY 1
    )
SELECT SF.SK_EMPRESA,
     SF.SK_PRODUTO,
     (SELECT SK_TEMPO_DIA FROM DIM_TEMPO_DIA WHERE NK_TEMPO_DIA = ?) AS SK_TEMPO_DIA,
    --SF.FABRICANTE,
    --SF.GRUPO,
    --SF.SUBGRUPO,
    --SF.PRECO_MEDIO,
    --SF.SITUACAO,*/
    SF.QTD_FISICO AS ESTOQUE_FISICO
    --SF.PESO_LIQUIDO,
    --(SF.QTD_FISICO * SF.PRECO_MEDIO) AS VLR_FISICO,
    --(SF.QTD_FISICO * SF.PESO_LIQUIDO) AS PESO_FISICO,*/
    --sum(SF.QTD_DISP)
    /*(SF.QTD_DISP * SF.PRECO_MEDIO) AS VLR_DISPONIVEL,
    (SF.QTD_DISP * SF.PESO_LIQUIDO) AS PESO_DISPONIVEL,
    COALESCE(V.QTD_VENDIDA, 0) AS QTD_VENDIDA,
    COALESCE(V.QTD_VENDA_DIRETA, 0) AS QTD_VENDA_DIRETA,
    (  CASE
            WHEN (SF.QTD_DISP - COALESCE(V.QTD_VENDIDA, 0)) &lt; 0
            THEN (SF.QTD_DISP - COALESCE(V.QTD_VENDIDA, 0)) * -1
            ELSE 0
        END
    ) AS SUG_COMPRA*/
FROM SALDO_FINAL SF
    LEFT OUTER JOIN VENDAS V USING (SK_PRODUTO)
WHERE SF.SITUACAO = 'ATIVO'
ORDER BY 2














  /*SELECT EMP.SK_EMPRESA, 
         PRO.SK_PRODUTO,
         DIA.SK_TEMPO_DIA,
         COALESCE((SELECT SUM(FT.QTD_EST_FISICO) 
            FROM FATO_MOVIMENTO_ESTOQUE_DIA FT
            INNER JOIN DIM_TEMPO_DIA DIA ON FT.SK_TEMPO_DIA = DIA.SK_TEMPO_DIA 
           WHERE FT.SK_EMPRESA = EMP.SK_EMPRESA
             AND FT.SK_PRODUTO = PRO.SK_PRODUTO
             AND DIA.NK_TEMPO_DIA &lt;= ?),0) AS ESTOQUE_FISICO
    FROM DIM_PRODUTO PRO, DIM_EMPRESA EMP, DIM_TEMPO_DIA DIA 
    WHERE DIA.NK_TEMPO_DIA = ? 
      AND PRO.ATIVO = 1*/
    </sql>
    <limit>0</limit>
    <lookup>Pega dia input</lookup>
    <execute_each_row>Y</execute_each_row>
    <variables_active>Y</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>399</xloc>
      <yloc>192</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table output</name>
    <type>TableOutput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>[DW] - PostgreSQL - Vistra BI</connection>
    <schema>public</schema>
    <table>FATO_SALDO_DIA_ESTOQUE</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field />
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field />
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field />
    <fields>
    </fields>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>713</xloc>
      <yloc>272</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
</transformation>
